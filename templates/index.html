<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NewsWeave Supreme | v46</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --glass-bg: rgba(8, 8, 16, 0.9);
            --border: 1px solid rgba(0, 243, 255, 0.3);
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #020205; color: white; font-family: var(--font-body); overflow-x: hidden; width: 100vw; }
        
        #video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; opacity: 0.4; }
        .grid-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 0%, #000 100%); z-index: -1; }
        .hidden { display: none !important; }
        
        /* SCALABLE CONTAINER */
        .app-container { width: 95%; max-width: 1600px; margin: 0 auto; padding: 2vh 0; display: flex; flex-direction: column; align-items: center; }
        
        /* HERO */
        .hero { text-align: center; margin-bottom: 3vh; transition: all 0.5s ease; }
        .logo { font-family: var(--font-head); font-size: clamp(2rem, 5vw, 5rem); background: linear-gradient(180deg, #fff, #888); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 40px var(--neon-blue); }
        .social-proof { display: inline-flex; align-items: center; gap: 10px; background: rgba(0,243,255,0.1); padding: 8px 20px; border-radius: 20px; border: var(--border); font-size: 0.9rem; margin-top: 10px; }
        .pulse { animation: pulse 2s infinite; color: #ff6b6b; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* CONTROL BAR */
        .control-bar {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: var(--glass-bg);
            padding: 15px; border-radius: 15px; border: var(--border); width: 100%; max-width: 1000px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 10;
        }
        .select-group { position: relative; flex: 1; min-width: 140px; }
        select, input {
            width: 100%; background: #0a0a10; color: white; border: 1px solid #333;
            padding: 12px; border-radius: 8px; font-family: var(--font-body); font-size: 1rem; outline: none;
        }
        input { min-width: 250px; flex: 2; }
        .btn-scan {
            background: var(--neon-blue); color: black; border: none; padding: 0 25px; border-radius: 8px;
            font-family: var(--font-head); cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .btn-scan:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--neon-blue); }

        /* LIVE INTEL BUTTON */
        .intel-btn {
            margin-top: 20px; background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); color: var(--neon-blue);
            padding: 10px 30px; border-radius: 30px; font-family: var(--font-head); cursor: pointer; transition: 0.3s;
        }
        .intel-btn:hover { background: var(--neon-blue); color: black; }

        /* TRENDING */
        .trending-panel {
            width: 100%; max-width: 1200px; margin-top: 20px; background: rgba(0,0,0,0.9); border: var(--border);
            border-radius: 12px; padding: 20px; display: none; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;
        }
        .trend-card { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .trend-card:hover { border-color: var(--neon-blue); }
        .trend-img { width: 100%; height: 140px; object-fit: cover; }
        .trend-title { padding: 10px; font-size: 0.9rem; font-weight: bold; }

        /* MAIN REPORT AREA (PDF TARGET) */
        .report-container {
            width: 100%; margin-top: 30px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
            opacity: 0; transform: translateY(20px); transition: 0.5s;
        }
        .report-col { background: var(--glass-bg); border: var(--border); border-radius: 12px; padding: 30px; }
        
        /* TEXT CONTENT */
        .content-box h2 { color: var(--neon-blue); font-family: var(--font-head); border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 20px; }
        .content-box p { font-size: 1.1rem; line-height: 1.6; color: #ddd; margin-bottom: 15px; }
        .content-box ul { padding-left: 20px; color: #ccc; }
        .content-box li { margin-bottom: 8px; }

        /* VISUAL COL */
        .visual-col { display: flex; flex-direction: column; gap: 20px; }
        .chart-box { background: rgba(0,0,0,0.5); border-radius: 8px; padding: 10px; min-height: 300px; border: 1px solid #333; }
        
        /* IMAGE GRID (20+ IMAGES) */
        .img-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;
            max-height: 600px; overflow-y: auto; padding-right: 5px;
        }
        .img-thumb { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .img-thumb:hover { border-color: var(--neon-blue); transform: scale(1.1); z-index: 2; }

        /* ACTION BAR */
        .action-bar { grid-column: span 2; display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-act { padding: 12px 30px; border-radius: 8px; font-family: var(--font-head); cursor: pointer; background: #222; border: 1px solid #555; color: white; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-act:hover { border-color: var(--neon-blue); background: #333; }
        .btn-act i { color: var(--neon-blue); }

        /* PDF MODE */
        .pdf-mode {
            background: white !important; color: black !important;
            padding: 40px !important; border: none !important;
        }
        .pdf-mode h2 { color: #00008b !important; border-bottom: 2px solid #000 !important; }
        .pdf-mode p, .pdf-mode li { color: #333 !important; }
        .pdf-mode .chart-box { border: 1px solid #ccc !important; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
        .modal img { max-width: 95%; max-height: 90%; border: 2px solid var(--neon-blue); box-shadow: 0 0 50px var(--neon-blue); }

        /* LOADING */
        #loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; text-align: center; }
        .spinner { width: 60px; height: 60px; border: 5px solid rgba(0,243,255,0.2); border-top: 5px solid var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .report-container { grid-template-columns: 1fr; }
            .action-bar { grid-column: span 1; }
            .logo { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <video id="video-background" autoplay muted loop playsinline><source src="/static/background.mp4" type="video/mp4"></video>
    <div class="grid-overlay"></div>

    <div class="app-container">
        <div class="hero" id="hero-sec">
            <h1 class="logo">NEWSWEAVE<br>SUPREME</h1>
            <div class="social-proof">
                <i class="fas fa-heart pulse"></i> <span id="likes">{{ total_likes }}</span> Verified Reports Generated
            </div>
        </div>

        <div class="control-bar">
            <div class="select-group">
                <select id="region">
                    {% for region in regions %} <option value="{{ region }}">{{ region }}</option> {% endfor %}
                </select>
            </div>
            <div class="select-group">
                <select id="mode">
                    <option value="Auto">Auto Mode</option>
                    <option value="Deep Research">Deep Research</option>
                    <option value="Market Analysis">Market Analysis</option>
                    <option value="Fact Check">Forensic Check</option>
                    <option value="Catalog">Catalog Data</option>
                </select>
            </div>
            <input type="text" id="topic" placeholder="Enter target topic (e.g. 'SpaceX 2026 Plans')...">
            <button class="btn-scan" onclick="runScan()"><i class="fas fa-search"></i> SCAN</button>
        </div>

        <button class="intel-btn" onclick="toggleTrend()"><i class="fas fa-satellite-dish"></i> LIVE GLOBAL INTEL</button>

        <div id="trend-panel" class="trending-panel"></div>

        <div id="loader">
            <div class="spinner"></div>
            <h3 style="font-family: var(--font-head); letter-spacing: 2px;">DEPLOYING AGENTS...</h3>
        </div>

        <div id="full-report" class="report-container hidden">
            <div class="report-col content-box" id="text-col">
                </div>

            <div class="report-col visual-col">
                <div id="chart-container" class="chart-box"></div>
                <h3 style="color:var(--neon-blue); font-family:var(--font-head); border-bottom:1px solid #333;">VISUAL EVIDENCE (25+)</h3>
                <div id="img-grid" class="img-grid"></div>
            </div>

            <div class="action-bar">
                <button class="btn-act" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> DOWNLOAD DOSSIER</button>
                <button class="btn-act" onclick="likeReport(this)"><i class="far fa-thumbs-up"></i> VERIFY & LIKE</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="this.style.display='none'"><img id="modal-img"></div>

    <script>
        // --- UI LOGIC ---
        function toggleTrend() {
            const p = document.getElementById('trend-panel');
            if (p.style.display === 'grid') { p.style.display = 'none'; }
            else { p.style.display = 'grid'; loadTrends(); }
        }

        async function loadTrends() {
            const p = document.getElementById('trend-panel');
            p.innerHTML = '<p style="color:#888;">Scanning frequencies...</p>';
            const reg = document.getElementById('region').value;
            
            try {
                const res = await fetch('/trending', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({region: reg}) });
                const data = await res.json();
                p.innerHTML = '';
                data.headlines.forEach(h => {
                    p.innerHTML += `
                    <div class="trend-card" onclick="autoScan('${h.title.replace(/'/g, "\\'")}')">
                        <img src="${h.image}" class="trend-img">
                        <div class="trend-title">${h.title}</div>
                    </div>`;
                });
            } catch(e) { p.innerHTML = 'Signal Lost.'; }
        }

        function autoScan(txt) {
            document.getElementById('topic').value = txt;
            document.getElementById('trend-panel').style.display = 'none';
            runScan();
        }

        // --- CORE SCAN ---
        async function runScan() {
            const topic = document.getElementById('topic').value;
            if(!topic) return alert("INPUT REQUIRED");

            document.getElementById('hero-sec').style.marginTop = '2vh'; // Compact mode
            document.getElementById('loader').style.display = 'block';
            const rep = document.getElementById('full-report');
            rep.classList.add('hidden');
            rep.style.opacity = 0;

            try {
                const res = await fetch('/analyze', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: topic,
                        region: document.getElementById('region').value,
                        mode: document.getElementById('mode').value
                    })
                });
                const data = await res.json();

                // 1. Text
                document.getElementById('text-col').innerHTML = data.report;

                // 2. Images (Handle 20+)
                const ig = document.getElementById('img-grid');
                ig.innerHTML = '';
                if(data.images && data.images.length > 0) {
                    data.images.forEach(img => {
                        ig.innerHTML += `<img src="${img.src}" class="img-thumb" onclick="viewImg('${img.src}')" title="${img.title}">`;
                    });
                } else { ig.innerHTML = '<p style="color:#666;">No verified imagery.</p>'; }

                // 3. Chart
                if(data.chart) {
                    Plotly.newPlot('chart-container', JSON.parse(data.chart), {responsive: true});
                } else {
                    document.getElementById('chart-container').innerHTML = '<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#666;">No numeric data extracted.</div>';
                }

                rep.classList.remove('hidden');
                setTimeout(() => { rep.style.opacity = 1; }, 100);

            } catch(e) { alert("SCAN FAILED: " + e); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function viewImg(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('modal').style.display = 'flex';
        }

        // --- PDF DOWNLOADER ---
        function downloadPDF() {
            const element = document.getElementById('full-report');
            const btns = document.querySelector('.action-bar');
            
            btns.style.display = 'none'; // Hide buttons for PDF
            element.classList.add('pdf-mode'); // Turn white for print
            
            const opt = {
                margin: 0.2,
                filename: 'NewsWeave_Dossier_v46.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.remove('pdf-mode');
                btns.style.display = 'flex';
            });
        }

        async function likeReport(btn) {
            await fetch('/like', {method:'POST'});
            btn.innerHTML = '<i class="fas fa-check"></i> VERIFIED';
            btn.style.color = '#00ff00';
            btn.style.borderColor = '#00ff00';
        }

        document.getElementById('topic').addEventListener('keypress', (e)=>{if(e.key==='Enter')runScan()});
    </script>
</body>
</html>
